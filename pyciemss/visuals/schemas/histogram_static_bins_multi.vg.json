{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "A small multiples view of histograms for visualizing univariate distributions using static bins.",
  "height": 500,
  "padding": 5,
  "signals": [
    {"name": "offset", "value": 40},
    {"name": "cellHeight", "value": 300},
    {"name": "cellWidth", "value": 200},
    {"name": "width", "update": "3 * (offset + cellWidth)"},
    {"name": "totalHeight", "update": "cellHeight * 1.2"},
    {
      "name": "axisLabels",
      "value": {
        "Site 1": {"xaxis": "Beta", "yaxis": "Frequency"},
        "Site 2": {"xaxis": "Gamma", "yaxis": "Frequency"},
        "Site 3": {"xaxis": "Alpha", "yaxis": "Frequency"}
      }
    },
    {
      "name": "yref",
      "value": {
        "Site 1": [
          {"number": 68000, "name": "line1", "color": "black", "type": "dashed"},
          {"number": 69000, "name": "line2", "color": "red", "type": "solid"}
        ],
        "Site 2": [
          {"number": 70000, "name": "line1", "color": "blue", "type": "dashed"}
        ],
        "Site 3": [
          {"number": 71000, "name": "line1", "color": "green", "type": "solid"}
        ]
      }
    }
  ],
  "data": [
    {
      "name": "binned",
      "values": [
        {"bin0": 68577.46875, "bin1": 70759.6796875, "count": 77, "label": "s30", "site": "Site 1"},
        {"bin0": 70759.6796875, "bin1": 72941.890625, "count": 65, "label": "s30", "site": "Site 1"},
        {"bin0": 72941.890625, "bin1": 75124.1015625, "count": 68, "label": "s30", "site": "Site 1"},
        {"bin0": 75124.1015625, "bin1": 77306.3125, "count": 81, "label": "s30", "site": "Site 1"},
        {"bin0": 77306.3125, "bin1": 79488.5234375, "count": 590, "label": "s30", "site": "Site 1"},
        {"bin0": 79488.5234375, "bin1": 81670.734375, "count": 123, "label": "s30", "site": "Site 1"},
        {"bin0": 68577.46875, "bin1": 70759.6796875, "count": 90, "label": "s40", "site": "Site 2"},
        {"bin0": 70759.6796875, "bin1": 72941.890625, "count": 60, "label": "s40", "site": "Site 2"},
        {"bin0": 72941.890625, "bin1": 75124.1015625, "count": 95, "label": "s40", "site": "Site 2"},
        {"bin0": 75124.1015625, "bin1": 77306.3125, "count": 70, "label": "s40", "site": "Site 2"},
        {"bin0": 77306.3125, "bin1": 79488.5234375, "count": 120, "label": "s40", "site": "Site 2"},
        {"bin0": 79488.5234375, "bin1": 81670.734375, "count": 130, "label": "s40", "site": "Site 2"},
        {"bin0": 68577.46875, "bin1": 70759.6796875, "count": 67, "label": "s50", "site": "Site 3"},
        {"bin0": 70759.6796875, "bin1": 72941.890625, "count": 80, "label": "s50", "site": "Site 3"},
        {"bin0": 72941.890625, "bin1": 75124.1015625, "count": 75, "label": "s50", "site": "Site 3"},
        {"bin0": 75124.1015625, "bin1": 77306.3125, "count": 79, "label": "s50", "site": "Site 3"},
        {"bin0": 77306.3125, "bin1": 79488.5234375, "count": 140, "label": "s50", "site": "Site 3"},
        {"bin0": 79488.5234375, "bin1": 81670.734375, "count": 105, "label": "s50", "site": "Site 3"}
      ]
    },
    {
      "name": "maxCounts",
      "source": "binned",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["site"],
          "fields": ["count"],
          "ops": ["max"],
          "as": ["maxCount"]
        }
      ]
    },
    {
      "name": "binRanges",
      "source": "binned",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["site"],
          "fields": ["bin0", "bin1"],
          "ops": ["min", "max"],
          "as": ["minBin", "maxBin"]
        }
      ]
    },
    {
      "name": "yrefData",
      "values": [
        {"site": "Site 1", "number": 68000, "name": "line1", "color": "black", "type": "dashed"},
        {"site": "Site 1", "number": 69000, "name": "line2", "color": "red", "type": "solid"},
        {"site": "Site 2", "number": 70000, "name": "line1", "color": "blue", "type": "dashed"},
        {"site": "Site 3", "number": 71000, "name": "line1", "color": "green", "type": "solid"}
      ]
    }
  ],
  "scales": [
    {
      "name": "gscale",
      "type": "band",
      "range": [0, {"signal": "width"}],
      "round": true,
      "domain": {"data": "binned", "field": "site"}
    },
    {
      "name": "color",
      "type": "ordinal",
      "domain": {"data": "binned", "field": "label"},
      "range": {"scheme": "dark2"}
    },
    {
      "name": "lineStyle",
      "type": "ordinal",
      "domain": ["dashed", "solid"],
      "range": [[5, 5], []]
    }
  ],
  "legends": [
    {
      "stroke": "color",
      "strokeDash": "lineStyle",
      "orient": "right",
      "title": "Reference Lines",
      "encode": {
        "symbols": {
          "enter": {
            "stroke": {"field": "color"},
            "strokeDash": {"field": "type"}
          }
        },
        "labels": {
          "enter": {
            "text": {"field": "name"}
          }
        }
      }
    }
  ],
  "marks": [
    {
      "name": "siteGroups",
      "type": "group",
      "from": {
        "facet": {
          "data": "binned",
          "name": "facetedData",
          "groupby": "site"
        }
      },
      "encode": {
        "enter": {
          "x": {"scale": "gscale", "field": "site", "offset": {"signal": "offset"}},
          "width": {"signal": "cellWidth"},
          "height": {"signal": "cellHeight"},
          "stroke": {"value": "#ccc"}
        }
      },
      "data": [
        {
          "name": "xScaleData",
          "source": "binRanges",
          "transform": [
            {
              "type": "filter",
              "expr": "datum.site === parent.site"
            }
          ]
        },
        {
          "name": "yScaleData",
          "source": "maxCounts",
          "transform": [
            {
              "type": "filter",
              "expr": "datum.site === parent.site"
            }
          ]
        },
        {
          "name": "filteredYrefData",
          "source": "yrefData",
          "transform": [
            {
              "type": "filter",
              "expr": "datum.site === parent.site"
            }
          ]
        }
      ],
      "scales": [
        {
          "name": "xscale",
          "type": "linear",
          "range": [0, {"signal": "cellWidth"}],
          "domain": {"data": "xScaleData", "fields": ["minBin", "maxBin"]},
          "zero": false,
          "nice": true
        },
        {
          "name": "yscale",
          "type": "linear",
          "range": [{"signal": "cellHeight"}, 0],
          "domain": {"data": "yScaleData", "field": "maxCount"},
          "zero": true,
          "nice": true
        }
      ],
      "axes": [
        {
          "orient": "bottom",
          "scale": "xscale",
          "zindex": 1,
          "labelOverlap": "parity",
          "labelSeparation": 10,
          "labelAngle": -45,
          "title": {"signal": "axisLabels[parent.site].xaxis"}
        },
        {
          "orient": "left",
          "scale": "yscale",
          "zindex": 1,
          "title": {"signal": "axisLabels[parent.site].yaxis"}
        }
      ],
      "marks": [
        {
          "name": "bins",
          "type": "rect",
          "from": {"data": "facetedData"},
          "encode": {
            "enter": {
              "fill": {"scale": "color", "field": "label"},
              "opacity": {"value": 0.7}
            },
            "update": {
              "x": {"scale": "xscale", "field": "bin0"},
              "x2": {"scale": "xscale", "field": "bin1", "offset": -0.5},
              "y": {"scale": "yscale", "field": "count"},
              "y2": {"scale": "yscale", "value": 0},
              "tooltip": {"signal": "{ 'Count': datum.count }"}
            },
            "hover": {
              "fill": {"value": "firebrick"}
            }
          }
        },
        {
          "type": "text",
          "encode": {
            "enter": {
              "x": {"signal": "cellWidth / 2"},
              "y": {"signal": "-10"},
              "align": {"value": "center"},
              "fontSize": {"value": 13},
              "text": {"signal": "parent.site"},
              "fontWeight": {"value": "bold"}
            }
          }
        },
        {
          "name": "refLines",
          "type": "rule",
          "from": {"data": "filteredYrefData"},
          "encode": {
            "enter": {
              "x": {"scale": "xscale", "field": "number"},
              "y": {"value": 0},
              "y2": {"signal": "cellHeight"},
              "stroke": {"field": "color"},
              "strokeDash": {"scale": "lineStyle", "field": "type"},
              "tooltip": {"signal": "{ 'Value': datum.name }"}
            }
          }
        }
      ]
    }
  ]
}
