{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "A small multiples view of histograms for visualizing univariate distributions using static bins.",
  "height": 500,
  "padding": 5,

  "signals": [
    {"name": "offset", "value": 40},
    {"name": "cellWidth", "value": 200},
    {"name": "width", "update": "3 * (offset + cellWidth)"}
  ],

  "data": [
    {
      "name": "binned",
      "values": [
        {"bin0": 68577.46875, "bin1": 70759.6796875, "count": 77, "label": "s30", "site": "Site 1"},
        {"bin0": 70759.6796875, "bin1": 72941.890625, "count": 65, "label": "s30", "site": "Site 1"},
        {"bin0": 72941.890625, "bin1": 75124.1015625, "count": 68, "label": "s30", "site": "Site 1"},
        {"bin0": 75124.1015625, "bin1": 77306.3125, "count": 81, "label": "s30", "site": "Site 1"},
        {"bin0": 77306.3125, "bin1": 79488.5234375, "count": 590, "label": "s30", "site": "Site 1"},
        {"bin0": 79488.5234375, "bin1": 81670.734375, "count": 123, "label": "s30", "site": "Site 1"},
        {"bin0": 68577.46875, "bin1": 70759.6796875, "count": 90, "label": "s40", "site": "Site 2"},
        {"bin0": 70759.6796875, "bin1": 72941.890625, "count": 60, "label": "s40", "site": "Site 2"},
        {"bin0": 72941.890625, "bin1": 75124.1015625, "count": 95, "label": "s40", "site": "Site 2"},
        {"bin0": 75124.1015625, "bin1": 77306.3125, "count": 70, "label": "s40", "site": "Site 2"},
        {"bin0": 77306.3125, "bin1": 79488.5234375, "count": 120, "label": "s40", "site": "Site 2"},
        {"bin0": 79488.5234375, "bin1": 81670.734375, "count": 130, "label": "s40", "site": "Site 2"},
        {"bin0": 68577.46875, "bin1": 70759.6796875, "count": 67, "label": "s50", "site": "Site 3"},
        {"bin0": 70759.6796875, "bin1": 72941.890625, "count": 80, "label": "s50", "site": "Site 3"},
        {"bin0": 72941.890625, "bin1": 75124.1015625, "count": 75, "label": "s50", "site": "Site 3"},
        {"bin0": 75124.1015625, "bin1": 77306.3125, "count": 79, "label": "s50", "site": "Site 3"},
        {"bin0": 77306.3125, "bin1": 79488.5234375, "count": 140, "label": "s50", "site": "Site 3"},
        {"bin0": 79488.5234375, "bin1": 81670.734375, "count": 105, "label": "s50", "site": "Site 3"}
      ]
    },
    {
      "name": "maxCounts",
      "source": "binned",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["site"],
          "fields": ["count"],
          "ops": ["max"],
          "as": ["maxCount"]
        }
      ]
    },
    {
      "name": "binRanges",
      "source": "binned",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["site"],
          "fields": ["bin0", "bin1"],
          "ops": ["min", "max"],
          "as": ["minBin", "maxBin"]
        }
      ]
    }
  ],

  "scales": [
    {
      "name": "gscale",
      "type": "band",
      "range": [0, {"signal": "width"}],
      "round": true,
      "domain": {"data": "binned", "field": "site"}
    },
    {
      "name": "color",
      "type": "ordinal",
      "domain": {"data": "binned", "field": "label"},
      "range": {"scheme": "dark2"}
    }
  ],

  "marks": [
    {
      "name": "siteGroups",
      "type": "group",
      "from": {
        "facet": {
          "data": "binned",
          "name": "facetedData",
          "groupby": "site"
        }
      },
      "encode": {
        "enter": {
          "x": {"scale": "gscale", "field": "site", "offset": {"signal": "offset"}},
          "width": {"signal": "cellWidth"},
          "height": {"signal": "height"},
          "stroke": {"value": "#ccc"}
        }
      },
      "data": [
        {
          "name": "xScaleData",
          "source": "maxCounts",
          "transform": [
            {
              "type": "filter",
              "expr": "datum.site === parent.site"
            }
          ]
        },
        {
          "name": "yScaleData",
          "source": "binRanges",
          "transform": [
            {
              "type": "filter",
              "expr": "datum.site === parent.site"
            }
          ]
        }
      ],
      "scales": [
        {
          "name": "xscale",
          "type": "linear",
          "range": [0, {"signal": "cellWidth"}],
          "domain": {"data": "xScaleData", "field": "maxCount"},
          "zero": true,
          "nice": true
        },
        {
          "name": "yscale",
          "type": "linear",
          "range": [0, {"signal": "height"}],
          "domain": {"data": "yScaleData", "fields": ["minBin", "maxBin"]},
          "zero": false,
          "nice": true
        }
      ],
      "axes": [
        {
          "orient": "bottom",
          "scale": "xscale",
          "zindex": 1,
          "labelOverlap": "parity",
          "labelSeparation": 20
        },
        {
          "orient": "left",
          "scale": "yscale",
          "zindex": 1
        }
      ],
      "marks": [
        {
          "name": "bins",
          "type": "rect",
          "from": {"data": "facetedData"},
          "encode": {
            "enter": {
              "fill": {"scale": "color", "field": "label"},
              "opacity": {"value": 0.7}
            },
            "update": {
              "x": {"scale": "xscale", "field": "count"},
              "x2": {"scale": "xscale", "value": 0},
              "y": {"scale": "yscale", "field": "bin0"},
              "y2": {"scale": "yscale", "field": "bin1", "offset": -0.5},
              "tooltip": {"signal": "{ 'Count': datum.count }"}
            },
            "hover": {
              "fill": {"value": "firebrick"}
            }
          }
        },
        {
          "type": "text",
          "encode": {
            "enter": {
              "x": { "signal": "cellWidth / 2" },
              "y": { "value": -10 },
              "align": { "value": "center" },
              "fontSize": { "value": 13 },
              "text": { "signal": "parent.site" },
              "fontWeight": { "value": "bold" }
            }
          }
        }
      ]
    }
  ]
}
