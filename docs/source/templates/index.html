<h1>Run Simulations</h1>
<form method="post" enctype="multipart/form-data" action="/">
    <div>
        <label for="models">Upload Models:</label>
        <input type="file" name="models" id="models" multiple onchange="onModelsChange()">
    </div>
    <div>
        <label for="calibrate_dataset">Upload Calibration Dataset:</label>
        <input type="file" name="calibrate_dataset" id="calibrate_dataset" onchange="onCalibrationChange()">
    </div>
    <div>
        <input type="checkbox" name="interventions" id="interventions">
        <label for="interventions">Use interventions</label>
    </div>
    <div>
        <input type="checkbox" name="ensemble" id="ensemble">
        <label for="ensemble">Ensemble Models</label>
    </div>
    
    <div>
        <label for="max-timestamp">Max Timestamp:</label>
        <span id="max-timestamp">{{ max_timestamp }}</span>
    </div>

    <div>
        <label for="param_id">Parameter ID:</label>
        <select name="param_id" id="param-id"></select>
    </div>
    <div>
        <label for="param_value">Parameter Value:</label>
        <input type="text" name="param_value" id="param-value">
    </div>
    <div>
        <label for="param_start_time">Parameter Start Time:</label>
        <input type="text" name="param_start_time" id="param-start-time" value="">
    </div>
  
    <button type="submit">Run Simulation</button>
</form>

<div>
    <h2>Generated Image</h2>
    <img src="{{ image_data }}" alt="Simulation Result Image">
</div>

<script>
    function updateMaxTimestamp(newTimestamp) {
        document.getElementById('max-timestamp').innerText = newTimestamp;
    }

    function onCalibrationChange() {
        const calibrateDatasetInput = document.getElementById('calibrate_dataset');
        const formData = new FormData();
        formData.append('calibrate_dataset_file', calibrateDatasetInput.files[0]);

        fetch('/update_max_timestamp', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
            } else {
                updateMaxTimestamp(data.max_timestamp);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function onModelsChange() {
        const modelsInput = document.getElementById('models');
        const formData = new FormData();
        formData.append('models_file', modelsInput.files[0]);

        fetch('/get_parameters', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Received data:', data);
            const paramIdSelect = document.getElementById('param-id');
            const paramValueInput = document.getElementById('param-value');

            // Clear existing options
            paramIdSelect.innerHTML = '';

            // Populate dropdown with parameter IDs
            data.forEach(param => {
                const option = document.createElement('option');
                option.value = param.id;
                option.text = param.id;
                paramIdSelect.appendChild(option);
            });

            // Set the value of param-value based on the first parameter
            if (data.length > 0) {
                const firstParam = data[0];
                paramValueInput.value = firstParam.value;
            } else {
                console.log('No parameters received');
            }

            // Update param-value when param-id changes
            paramIdSelect.addEventListener('change', function() {
                const selectedParam = data.find(param => param.id === paramIdSelect.value);
                paramValueInput.value = selectedParam.value;
            });
        })
        .catch(error => console.error('Error:', error));
    }
</script>